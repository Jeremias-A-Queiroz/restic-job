<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restic Job // Dashboard</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
	/* 
	 * Theme: InfraLinux "Phosphor" (Dark Mode)
	 */
	:root {
	    --bg-color: #1d2021;
	    --surface-bg: #282828;
	    --surface-highlight: #3c3836;
	    --text-main: #ebdbb2;
	    --text-dim: #a89984;
	    --accent-primary: #d79921;
	    --accent-secondary: #458588;
	    --accent-alert: #cc241d;
	    --accent-success: #98971a;
	    --border-dim: #3c3836;

	    --font-sans: "Inter", sans-serif;
	    --font-mono: "JetBrains Mono", monospace;
	}

	body {
	    background-color: var(--bg-color);
	    color: var(--text-main);
	    font-family: var(--font-sans);
	    margin: 0;
	    padding: 2em 0;
	    line-height: 1.5;
	    overflow-y: scroll;
	}

	#dashboard {
	    width: 95%;
	    max-width: 1200px; /* Slightly wider for extra columns */
	    margin: 0 auto;
	}

	/* HEADER */
	header {
	    border-bottom: 1px solid var(--border-dim);
	    padding-bottom: 1.5em;
	    margin-bottom: 2em;
	    display: flex;
	    flex-wrap: wrap;
	    justify-content: space-between;
	    align-items: flex-end;
	}

	h1 {
	    font-family: var(--font-mono);
	    color: var(--accent-primary);
	    margin: 0;
	    font-size: 1.8em;
	    letter-spacing: -0.05em;
	}

	.subtitle {
	    font-size: 0.85em;
	    color: var(--text-dim);
	    margin-top: 0.2em;
	}

	.stats-grid { display: flex; gap: 2em; }
	.stat-item { text-align: right; }
	.stat-item .label { font-size: 0.75em; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; }
	.stat-item .value { font-size: 1.2em; font-family: var(--font-mono); color: var(--text-main); font-weight: bold; }

	/* CHARTS LAYOUT */
	.charts-row {
	    display: grid;
	    grid-template-columns: 1fr;
	    gap: 1.5em;
	    margin-bottom: 2em;
	}

	@media (min-width: 850px) {
	    .charts-row { grid-template-columns: 2fr 1fr; }
	}

	.card {
	    background-color: var(--surface-bg);
	    border: 1px solid var(--border-dim);
	    border-radius: 4px;
	    padding: 1em;
	}

	.card h3 {
	    margin: 0 0 1em 0;
	    font-size: 0.85em;
	    font-family: var(--font-sans);
	    color: var(--text-dim);
	    text-transform: uppercase;
	    border-bottom: 1px solid var(--border-dim);
	    padding-bottom: 0.5em;
	}

	.chart-box { position: relative; height: 280px; width: 100%; }

	/* DATA TABLE */
	.history-container {
	    background-color: var(--surface-bg);
	    border: 1px solid var(--border-dim);
	    border-radius: 4px;
	    position: relative;
	}

	.table-scroll {
	    max-height: 450px;
	    overflow-y: auto;
	}

	/* Scrollbar Styling */
	.table-scroll::-webkit-scrollbar { width: 8px; }
	.table-scroll::-webkit-scrollbar-track { background: var(--surface-bg); }
	.table-scroll::-webkit-scrollbar-thumb { background: var(--border-dim); border-radius: 4px; }
	.table-scroll::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }

	table {
	    width: 100%;
	    border-collapse: collapse;
	    font-family: var(--font-mono);
	    font-size: 0.80em; /* Slightly smaller for density */
	}

	th {
	    background-color: var(--surface-highlight);
	    color: var(--accent-primary);
	    text-align: left;
	    padding: 0.8em 1em;
	    position: sticky;
	    top: 0;
	    z-index: 10;
	    box-shadow: 0 1px 0 var(--border-dim);
	}

	td {
	    padding: 0.6em 1em;
	    border-bottom: 1px solid var(--border-dim);
	    color: var(--text-dim);
	    white-space: nowrap;
	}

	tr.data-row { cursor: help; }
	tr.data-row:hover td {
	    background-color: var(--surface-highlight);
	    color: var(--text-main);
	}

	.tag {
	    display: inline-block;
	    padding: 2px 6px;
	    border: 1px solid var(--border-dim);
	    border-radius: 3px;
	    font-size: 0.9em;
	    color: var(--accent-secondary);
	    background: rgba(0,0,0,0.2);
	}

	.meta-sub {
	    font-size: 0.85em;
	    color: var(--text-dim);
	    opacity: 0.7;
	    margin-left: 0.5em;
	}

	.diff-new { color: var(--accent-success); }
	.diff-chg { color: var(--accent-primary); }

	/* POPUP TOOLTIP */
	#detail-popup {
	    position: fixed;
	    display: none;
	    background-color: #181a1b; /* Darker than surface */
	    border: 1px solid var(--accent-secondary);
	    padding: 1em;
	    border-radius: 4px;
	    box-shadow: 0 8px 24px rgba(0,0,0,0.6);
	    z-index: 1000;
	    width: 400px;
	    font-family: var(--font-mono);
	    font-size: 0.8em;
	    color: var(--text-main);
	    pointer-events: none; /* Let mouse pass through */
	}

	.popup-header {
	    border-bottom: 1px solid var(--border-dim);
	    margin-bottom: 0.8em;
	    padding-bottom: 0.5em;
	    font-weight: bold;
	    color: var(--accent-secondary);
	}

	.popup-grid {
	    display: grid;
	    grid-template-columns: 1fr 1fr;
	    gap: 0.5em 1.5em;
	}

	.popup-row { display: contents; }
	.popup-label { color: var(--text-dim); }
	.popup-val { text-align: right; }

	.popup-full {
	    grid-column: 1 / -1;
	    margin-top: 0.5em;
	    padding-top: 0.5em;
	    border-top: 1px dashed var(--border-dim);
	}

	footer {
	    margin-top: 3em;
	    text-align: center;
	    font-size: 0.75em;
	    color: var(--text-dim);
	    font-family: var(--font-mono);
	    opacity: 0.6;
	}
    </style>
</head>
<body>

<div id="dashboard">
    <header>
	<div>
	    <h1>RESTIC_JOB // DASHBOARD</h1>
	    <div class="subtitle">System Status: <span style="color:var(--accent-success)">ONLINE</span></div>
	</div>
	<div class="stats-grid">
	    <div class="stat-item">
		<div class="label">Repo Size</div>
		<div class="value" id="stat-size">--</div>
	    </div>
	    <div class="stat-item">
		<div class="label">Snapshots</div>
		<div class="value" id="stat-count">--</div>
	    </div>
	    <div class="stat-item">
		<div class="label">Total Files</div>
		<div class="value" id="stat-files">--</div>
	    </div>
	</div>
    </header>

    <div class="charts-row">
	<!-- Chart 1: Bar (Recent Incremental) -->
	<div class="card">
	    <h3>Incremental Data Added (Last 7 Executions)</h3>
	    <div class="chart-box">
		<canvas id="chartAdded"></canvas>
	    </div>
	</div>

	<!-- Chart 2: Doughnut (Storage Distribution) -->
	<div class="card">
	    <h3>Storage Distribution (By Tag)</h3>
	    <div class="chart-box">
		<canvas id="chartDist"></canvas>
	    </div>
	</div>
    </div>

    <div class="history-container">
	<div class="table-scroll">
	    <table id="snapshotTable">
		<thead>
		    <tr>
			<th>Time <span style="font-weight:normal; opacity:0.7">(Duration)</span></th>
			<th>Host</th>
			<th>ID</th>
			<th>Tags</th>
			<th>Î” Files</th>
			<th style="text-align:right;">+ Added</th>
			<th style="text-align:right;">Total Size</th>
		    </tr>
		</thead>
		<tbody>
		    <!-- JS Injected -->
		</tbody>
	    </table>
	</div>
    </div>

    <footer>
	<span id="last-update"></span> &bull; restic-job v1.7
    </footer>
</div>

<!-- Hidden Tooltip Element -->
<div id="detail-popup"></div>

<script>
    const CONFIG = {
	urls: { snapshots: 'snapshots.json', stats: 'stats.json' },
	colors: {
	    text: '#a89984',
	    grid: '#3c3836',
	    bar: '#d79921',
	    pie: ['#458588', '#98971a', '#d79921', '#b16286', '#689d6a']
	}
    };

    // --- Helpers ---

    function formatBytes(bytes, decimals = 2) {
	if (!+bytes) return '0 B';
	const k = 1024;
	const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
	const i = Math.floor(Math.log(bytes) / Math.log(k));
	return `${parseFloat((bytes / Math.pow(k, i)).toFixed(decimals))} ${sizes[i]}`;
    }

    function formatDate(isoStr) {
	const d = new Date(isoStr);
	return d.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'}) + ' ' + 
	       d.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
    }

    function calculateDuration(startStr, endStr) {
	const start = new Date(startStr);
	const end = new Date(endStr);
	const ms = end - start;

	if (isNaN(ms)) return "--";

	const sec = Math.floor(ms / 1000);
	const min = Math.floor(sec / 60);
	const hr = Math.floor(min / 60);

	if (hr > 0) return `${hr}h ${min % 60}m`;
	if (min > 0) return `${min}m ${sec % 60}s`;
	return `${sec}s`;
    }

    function generatePopupContent(s) {
	const d_new = s.summary.dirs_new || 0;
	const d_chg = s.summary.dirs_changed || 0;
	const tree_blobs = s.summary.tree_blobs || 0;
	const data_blobs = s.summary.data_blobs || 0;
	const paths = (s.paths || []).join('<br>');

	return `
	    <div class="popup-header">Snapshot Details: ${s.short_id}</div>
	    <div class="popup-grid">
		<div class="popup-row"><span class="popup-label">Parent ID:</span> <span class="popup-val">${s.parent ? s.parent.substring(0,8) : 'ROOT'}</span></div>
		<div class="popup-row"><span class="popup-label">Program:</span> <span class="popup-val">${s.program_version}</span></div>

		<div class="popup-row"><span class="popup-label">Files New:</span> <span class="popup-val" style="color:var(--accent-success)">${s.summary.files_new}</span></div>
		<div class="popup-row"><span class="popup-label">Files Changed:</span> <span class="popup-val" style="color:var(--accent-primary)">${s.summary.files_changed}</span></div>

		<div class="popup-row"><span class="popup-label">Dirs New:</span> <span class="popup-val">${d_new}</span></div>
		<div class="popup-row"><span class="popup-label">Dirs Changed:</span> <span class="popup-val">${d_chg}</span></div>

		<div class="popup-row"><span class="popup-label">Data Blobs:</span> <span class="popup-val">${data_blobs}</span></div>
		<div class="popup-row"><span class="popup-label">Tree Blobs:</span> <span class="popup-val">${tree_blobs}</span></div>

		<div class="popup-full">
		    <span class="popup-label">Paths:</span><br>
		    <span style="color:var(--text-main)">${paths}</span>
		</div>
	    </div>
	`;
    }

    // --- Main Logic ---

    async function init() {
	try {
	    const [snapRes, statsRes] = await Promise.all([
		fetch(CONFIG.urls.snapshots),
		fetch(CONFIG.urls.stats)
	    ]);

	    const snapshots = await snapRes.json();
	    const stats = await statsRes.json();

	    // 1. Header Stats
	    document.getElementById('stat-size').innerText = formatBytes(stats.total_size);
	    document.getElementById('stat-count').innerText = stats.snapshots_count;
	    document.getElementById('stat-files').innerText = new Intl.NumberFormat('pt-BR').format(stats.total_file_count);
	    document.getElementById('last-update').innerText = new Date().toLocaleString();

	    // 2. Data Prep
	    const sorted = [...snapshots].sort((a, b) => new Date(a.time) - new Date(b.time));
	    const sliceBar = sorted.slice(-7);
	    const tagMap = {};
	    sorted.forEach(s => {
		const tag = (s.tags && s.tags[0]) ? s.tags[0] : 'Other';
		tagMap[tag] = s.summary.total_bytes_processed;
	    });

	    // 3. Charts
	    const commonOptions = {
		responsive: true,
		maintainAspectRatio: false,
		animation: { duration: 1000, easing: 'easeOutQuart' },
		plugins: { legend: { display: false } }
	    };

	    new Chart(document.getElementById('chartAdded'), {
		type: 'bar',
		data: {
		    labels: sliceBar.map(s => {
			const t = new Date(s.time);
			return `${t.getDate()}/${(t.getMonth()+1).toString().padStart(2,'0')} (${s.tags[0]||'-'})`;
		    }),
		    datasets: [{
			data: sliceBar.map(s => s.summary.data_added),
			backgroundColor: CONFIG.colors.bar,
			borderRadius: 2,
			barPercentage: 0.6
		    }]
		},
		options: {
		    ...commonOptions,
		    scales: {
			x: { ticks: { color: CONFIG.colors.text, font: {family:'JetBrains Mono', size:10} }, grid: { display: false } },
			y: { 
			    ticks: { color: CONFIG.colors.text, font: {family:'JetBrains Mono', size:10}, callback: v => formatBytes(v, 0) },
			    grid: { color: CONFIG.colors.grid, borderDash:[2,2] },
			    beginAtZero: true
			}
		    }
		}
	    });

	    new Chart(document.getElementById('chartDist'), {
		type: 'doughnut',
		data: {
		    labels: Object.keys(tagMap),
		    datasets: [{
			data: Object.values(tagMap),
			backgroundColor: CONFIG.colors.pie,
			borderColor: '#1d2021',
			borderWidth: 2
		    }]
		},
		options: {
		    ...commonOptions,
		    plugins: {
			legend: { display: true, position: 'right', labels: { color: CONFIG.colors.text, font: {family:'Inter', size:11}, boxWidth: 12 } }
		    },
		    cutout: '55%'
		}
	    });

	    // 4. Table Render (Newest First)
	    const tbody = document.querySelector('#snapshotTable tbody');
	    const tableData = [...snapshots].sort((a,b) => new Date(b.time) - new Date(a.time)).slice(0, 40);

	    tbody.innerHTML = tableData.map((s, index) => {
		const duration = calculateDuration(s.summary.backup_start, s.summary.backup_end);
		const filesNew = s.summary.files_new || 0;
		const filesChg = s.summary.files_changed || 0;

		// Storing JSON stringified in a data attribute for easy tooltip access
		// Using encodeURIComponent to be safe against special chars in paths
		const safeJson = encodeURIComponent(JSON.stringify(s));

		return `
		<tr class="data-row" data-json="${safeJson}">
		    <td>
			${formatDate(s.time)} 
			<span class="meta-sub">(${duration})</span>
		    </td>
		    <td>${s.hostname}</td>
		    <td style="font-family:var(--font-mono); color:var(--accent-primary);">${s.short_id}</td>
		    <td>${(s.tags||[]).map(t => `<span class="tag">${t}</span>`).join(' ')}</td>
		    <td style="font-family:var(--font-mono);">
			<span class="diff-new">+${filesNew}</span> <span style="opacity:0.3">/</span> 
			<span class="diff-chg">~${filesChg}</span>
		    </td>
		    <td style="text-align:right; color:var(--accent-success); font-family:var(--font-mono);">+${formatBytes(s.summary.data_added)}</td>
		    <td style="text-align:right; font-family:var(--font-mono);">${formatBytes(s.summary.total_bytes_processed)}</td>
		</tr>
		`;
	    }).join('');

	    // 5. Tooltip Logic
	    const popup = document.getElementById('detail-popup');
	    const rows = document.querySelectorAll('.data-row');

	    rows.forEach(row => {
		row.addEventListener('mouseenter', (e) => {
		    const data = JSON.parse(decodeURIComponent(row.dataset.json));
		    popup.innerHTML = generatePopupContent(data);
		    popup.style.display = 'block';
		});

		row.addEventListener('mousemove', (e) => {
		    // Position popup near mouse, but avoid overflow
		    // Simple logic: 15px right, 15px down from cursor
		    let x = e.clientX + 15;
		    let y = e.clientY + 15;

		    // If close to bottom, move up
		    if (y + popup.offsetHeight > window.innerHeight) {
			y = e.clientY - popup.offsetHeight - 10;
		    }
		    // If close to right, move left
		    if (x + popup.offsetWidth > window.innerWidth) {
			x = e.clientX - popup.offsetWidth - 10;
		    }

		    popup.style.left = x + 'px';
		    popup.style.top = y + 'px';
		});

		row.addEventListener('mouseleave', () => {
		    popup.style.display = 'none';
		});
	    });

	} catch (err) {
	    console.error(err);
	    document.getElementById('dashboard').innerHTML = `<h3 style="color:#cc241d; text-align:center; margin-top:3em;">Error Loading Data<br><small>${err.message}</small></h3>`;
	}
    }

    init();
</script>

</body>
</html>
